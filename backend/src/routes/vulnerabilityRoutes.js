import { Router } from "express";
import { z } from "zod";
import { requireAuth, requireRole } from "../middleware/auth.js";
import { VulnerabilityModel } from "../models/Vulnerability.js";

const router = Router();

const vulnerabilitySchema = z.object({
  title: z.string().min(3),
  description: z.string().min(10),
  severity: z.enum(["low", "medium", "high", "critical"]),
  status: z.enum(["open", "in_review", "fixed", "closed"]).optional(),
  category: z.string().optional(),
  assignedTo: z.string().optional(),
});

router.get("/", requireAuth, async (req, res) => {
  const { severity, status, category, q } = req.query;
  const filter = {};
  if (severity) filter.severity = severity;
  if (status) filter.status = status;
  if (category) filter.category = category;
  if (q) filter.title = { $regex: q, $options: "i" };

  const items = await VulnerabilityModel.find(filter).sort({ updatedAt: -1 });
  res.json(items);
});

router.post("/", requireAuth, async (req, res) => {
  const parsed = vulnerabilitySchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ message: parsed.error.message });

  const doc = await VulnerabilityModel.create({
    ...parsed.data,
    createdBy: req.user.id,
    status: parsed.data.status || "open",
  });
  res.status(201).json(doc);
});

router.get("/:id", requireAuth, async (req, res) => {
  const item = await VulnerabilityModel.findById(req.params.id);
  if (!item) return res.status(404).json({ message: "Not found" });
  res.json(item);
});

router.put("/:id", requireAuth, async (req, res) => {
  const parsed = vulnerabilitySchema.partial().safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ message: parsed.error.message });

  const item = await VulnerabilityModel.findById(req.params.id);
  if (!item) return res.status(404).json({ message: "Not found" });

  // Check if user is admin/owner OR owns the bug
  const isAdminOrOwner = req.user.role === "admin" || req.user.role === "owner";
  const isBugOwner = item.createdBy.toString() === req.user.id.toString();

  if (!isAdminOrOwner && !isBugOwner) {
    return res.status(403).json({ message: "You can only edit bugs you created" });
  }

  const updated = await VulnerabilityModel.findByIdAndUpdate(
    req.params.id,
    { ...parsed.data },
    { new: true }
  );
  res.json(updated);
});

router.delete("/:id", requireAuth, requireRole(["admin", "owner"]), async (req, res) => {
  const deleted = await VulnerabilityModel.findByIdAndDelete(req.params.id);
  if (!deleted) return res.status(404).json({ message: "Not found" });
  res.json({ message: "Deleted" });
});

export default router;


